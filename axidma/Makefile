# Makefile
#
# Date: March 5, 2016
# Author: Brandon Perez
# Author: Jared Choi
#
# The Makefile for building the AXI DMA driver.

###############################################################################
# Configuration
###############################################################################

# Allow the user to specify cross-compilation from the command line
CC = $(CROSS_COMPILE)gcc

# The locations of the header files.
INC_DIRS = ../inc ../axidma

# Add the include directory to the CFLAGS for the kernel. This must be an absolute path.
INC_FLAGS := $(addprefix -I $(PWD)/, $(INC_DIRS))
EXTRA_CFLAGS +:= $(INC_FLAGS)

# When natively compiling, we can infer the kernel's source tree directory.
# Otherwise, this must be specified by the user on the command line
ifndef CROSS_COMPILE
	KERNEL_VERSION = $(shell uname -r)
	KBUILD_DIR ?= /lib/modules/$(KERNEL_VERSION)/build/
endif

# Add this module to the list of modules to compile for the kernel
MODULE_NAME = axidma
$(MODULE_NAME)-objs := axi_dma.o axidma_dma.o axidma_chrdev.o
obj-m += $(MODULE_NAME).o

###############################################################################
# Targets
###############################################################################

# None of the targets correspond to actual files
.PHONY: all clean check

# Compile the AXI DMA driver
all: check
	make -C $(KBUILD_DIR) SUBDIRS=$(PWD) modules

# Clean up the intermediate files generated by compilation
clean: check
	make -C $(KBUILD_DIR) SUBDIRS=$(PWD) clean

# Make sure that the user defined all of the needed variables
check:
ifndef KBUILD_DIR
	@echo "Error: The variable KBUILD_DIR must be specified when cross-compiling."
	@exit 1
endif
