# Makefile
#
# Date: March 6, 2016
# Author: Brandon Perez
# Author: Jared Choi

################################################################################
# Configuration
################################################################################

# The list of example programs
EXAMPLES_DIR = examples
EXAMPLES_FILES = axidma_benchmark.c axidma_display_image.c axidma_transfer.c

# The variations of specific targets for the example programs
EXAMPLES_TARGETS = $(EXAMPLES_FILES:%.c=%)
EXAMPLES_DEBUG_TARGETS = $(addsuffix _debug,$(EXAMPLES_TARGETS))
EXAMPLES_CLEAN_TARGETS = $(addsuffix _clean,$(EXAMPLES_TARGETS))
EXAMPLES_EXECUTABLES = $(addprefix $(EXAMPLES_DIR)/,$(EXAMPLES_TARGETS))
EXAMPLES_OUTPUT_EXECUTABLES = $(addprefix $(OUTPUT_DIR)/,$(EXAMPLES_TARGETS))

# The location of the AXI DMA library used for compilation
LIBAXIDMA_DIR = libaxidma
LIBAXIDMA_FILES = libaxidma.c
LIBAXIDMA = $(addprefix $(LIBAXIDMA_DIR)/,$(LIBAXIDMA_FILES))

# The local helper function files used across the example programs.
UTIL_DIR = $(EXAMPLES_DIR)
UTIL_FILES = dma_util.c util.c
UTIL = $(addprefix $(UTIL_DIR)/,$(UTIL_FILES))

# Compile at O3 by default, and add debug flags for any debug targets
EXAMPLES_CFLAGS = $(GLOBAL_CFLAGS) -O3
debug $(EXAMPLES_DEBUG_TARGETS): EXAMPLES_CFLAGS = $(GLOBAL_CFLAGS) -g -O0

################################################################################
# Targets
################################################################################

# These targets don't correspond to actual generated files
.PHONY: all examples examples_debug examples_clean $(EXAMPLES_TARGETS) \
		$(EXAMPLES_DEBUG_TARGETS) $(EXAMPLES_CLEAN_TARGETS)

# Allow for secondary expansion in prerequisite lists. This allows for automatic
# variables (e.g. $@, $^, etc.) to be used in prerequisite lists.
.SECONDEXPANSION:

# Build all of the example files
examples examples_debug: $(EXAMPLES_TARGETS)

# User-facing targets for compiling examples with and without debug mode
$(EXAMPLES_TARGETS): $(OUTPUT_DIR)/$$@
$(EXAMPLES_DEBUG_TARGETS): $(OUTPUT_DIR)/$$(patsubst %_debug,%,$$@)

# Compile a given example into an executable. The check target is phony, so
# don't force these targets to run because of the target.
$(EXAMPLES_EXECUTABLES): $$@.c $(LIBAXIDMA) $(LIBAXIDMA_INC) $(UTIL) | cross_compiler_check
	$(CC) $(EXAMPLES_CFLAGS) $(LIBAXIDMA_INC_FLAGS) $(filter %.c,$^) -o $@

# Copy a compiled example executable to the specified output directory
$(EXAMPLES_OUTPUT_EXECUTABLES): $(EXAMPLES_DIR)/$$(shell basename $$@) \
							    $(OUTPUT_DIR)
	@cp $< $@

# Clean up all the files generated by compiling the examples
examples_clean: $(EXAMPLES_CLEAN_TARGETS)

# Clean a specific example by deleting both copies of the executable
$(EXAMPLES_CLEAN_TARGETS):
	rm -f $(OUTPUT_DIR)/$(@:%_clean=%) $(EXAMPLES_DIR)/$(@:%_clean=%)
