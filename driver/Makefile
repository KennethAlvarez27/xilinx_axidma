# Makefile
#
# Date: March 5, 2016
# Author: Brandon Perez
# Author: Jared Choi
#
# The Makefile for building the AXI DMA driver.

###############################################################################
# Configuration
###############################################################################

# Set the shell to bash
SHELL = /bin/bash

# Allow the user to specify cross-compilation from the command line
CC = $(CROSS_COMPILE)gcc

# The locations of the header files.
INC_DIRS = ../include

# Add the include directory to the CFLAGS for the kernel. This must be an absolute path.
INC_FLAGS := $(addprefix -I $(PWD)/, $(INC_DIRS))
EXTRA_CFLAGS += $(INC_FLAGS) -Werror

# When natively compiling, we can infer the kernel's source tree directory.
# Otherwise, this must be specified by the user on the command line
ifndef CROSS_COMPILE
	KERNEL_VERSION = $(shell uname -r)
	KBUILD_DIR ?= /lib/modules/$(KERNEL_VERSION)/build/
endif

# Add this module to the list of modules to compile for the kernel
MODULE_NAME = axidma
$(MODULE_NAME)-objs := axi_dma.o axidma_dma.o axidma_chrdev.o axidma_of.o
obj-m += $(MODULE_NAME).o

###############################################################################
# Targets
###############################################################################

# None of the targets correspond to actual files
.PHONY: all clean check create_output_dir

# Compile the AXI DMA driver
all: check create_output_dir
	make -C $(KBUILD_DIR) SUBDIRS=$(PWD) modules
ifdef OUTPUT_DIR
	cp $(MODULE_NAME).ko $(OUTPUT_DIR)
endif

# Creates the output directory where the kernel object file is stored
create_output_dir:
ifdef OUTPUT_DIR
	@mkdir -p $(OUTPUT_DIR)
endif

# Clean up the intermediate files generated by compilation
clean: check
	make -C $(KBUILD_DIR) SUBDIRS=$(PWD) clean
ifdef OUTPUT_DIR
	rm -f $(OUTPUT_DIR)/$(MODULE_NAME).ko
endif

# Make sure that the user defined all of the needed variables
check:
ifndef KBUILD_DIR
	@printf "Error: The variable KBUILD_DIR must be specified when cross-compiling.\n"
	@exit 1
endif
ifeq (,$(wildcard $(KBUILD_DIR)))
	@printf "Error: $(KBUILD_DIR): The kernel build (source tree) directory does not exist.\n"
	@exit 1
endif
